/* NM: Shop search script */
!function(e){"use strict";e.extend(e.nmTheme,{search_init:function(){var s=this;s.headerSearch="0"!==nm_wp_vars.shopSearchHeader,s.searchCurrentQuery="",s.headerSearch&&("0"!==nm_wp_vars.searchSuggestions?(s.instantSuggestions="0"!==nm_wp_vars.searchSuggestionsInstant,s.instantSuggestions&&(s.instantSuggestionsPreloaderTo=null,s.instantSuggestionsLoad()),s.suggestions=!0,s.suggestionsAjax=null,s.suggestionsCacheEnabled=!0,s.suggestionsCache={},s.suggestionsMaxResults=nm_wp_vars.searchSuggestionsMax):s.suggestions=!1,s.$searchPanel=e("#nm-header-search"),s.$searchBtn=e("#nm-menu-search-btn"),s.$searchInput=e("#nm-header-search-input"),s.$searchNotice=e("#nm-header-search-notice"),s.$searchKeywords=e("#nm-search-keywords"),s.headerSearchBind()),s.shopSearch=!s.headerSearch&&"0"!==nm_wp_vars.shopSearch,s.isShop&&s.shopSearch&&(s.$searchBtn=e("#nm-shop-search-btn"),s.$searchPanel=e("#nm-shop-search"),s.$searchInput=e("#nm-shop-search-input"),s.$searchNotice=e("#nm-shop-search-notice"),s.searchAjax=null,s.currentSearch="",s.shopSearchBind())},searchValidateInput:function(e,s){var a=e.replace(/ /g,"");return s||this.searchCurrentQuery!=a?a.length>0&&e.length>nm_wp_vars.shopSearchMinChar-1?(this.searchCurrentQuery=a,"valid"):"invalid":"unchanged"},searchShowNotice:function(){this.$searchNotice.addClass("show")},searchHideNotice:function(){this.$searchNotice.removeClass("show")},headerSearchBind:function(){var s=this;s.$searchBtn.on("click",(function(e){e.preventDefault(),s.headerSearchTogglePanel()})),e("#nm-header-search-close").on("click",(function(e){e.preventDefault(),s.headerSearchTogglePanel()}));s.$searchInput.on("input",(function(){var a=e(this).val(),n=s.searchValidateInput(a);"valid"===n?(s.headerSearchKeywordsHide(),s.suggestions?s.suggestionsGet(a):s.searchShowNotice()):"invalid"===n&&(s.headerSearchKeywordsShow(),s.suggestions?s.suggestionsHide():s.searchHideNotice())})).trigger("input"),s.$searchInput.on("keypress",(function(a){var n=e(this);"13"==(a.keyCode?a.keyCode:a.which)&&(a.preventDefault(),s.suggestionsAjax&&s.suggestionsAjax.abort(),s.headerSearchStaticSearch(n))})),s.$document.on("keydown",(function(e){"27"==(e.keyCode?e.keyCode:e.which)&&s.$body.hasClass(s.classSearchOpen)&&s.headerSearchTogglePanel()})),e("#nm-header-search-clear-button").on("click",(function(e){e.preventDefault(),s.$searchInput.val("").trigger("input")})),s.suggestions&&s.$searchKeywords.on("click",".button",(function(a){a.preventDefault();var n=e(this).text();s.$searchInput.val(n).focus().trigger("input")}))},headerSearchTogglePanel:function(){var s=this,a=0;return s.suggestions&&s.$body.hasClass(s.classSearchOpen)&&e("#nm-search-suggestions-notice").hasClass("show")&&(s.suggestionsHide(),a=100),s.$body.hasClass(s.classMobileMenuOpen)&&s.mobileMenuClose(!1),setTimeout((function(){s.$body.toggleClass(s.classSearchOpen),s.$body.hasClass(s.classSearchOpen)?(s.$searchPanel.addClass("is-visible"),s.pageOverlayShow(),e("#nm-header-search-input").trigger("focus")):(s.pageOverlayHide(),setTimeout((function(){s.$searchPanel.removeClass("is-visible"),e("#nm-header-search-input").val(""),s.headerSearchKeywordsShow()}),s.panelsAnimSpeed+150)),s.searchHideNotice()}),a),a},headerSearchKeywordsHide:function(){this.$searchKeywords.addClass("hide").removeClass("show")},headerSearchKeywordsShow:function(){var e=this;e.$searchKeywords.removeClass("hide"),setTimeout((function(){e.$searchKeywords.addClass("show")}),50)},headerSearchStaticSearch:function(s){var a=this,n=s.val();if("valid"===a.searchValidateInput(n,!0)){a.searchHideNotice(),a.suggestions&&(e("#nm-header-search-form").addClass("nm-loader"),e(".nm-header-search-wrap").addClass("redirecting"));var r=nm_wp_vars.shopSearchUrl.toString().replace("%%nmsearchkey%%",encodeURIComponent(n));window.location.href=r}},shopSearchBind:function(){var s=this;e("#nm-shop-search-close").on("click",(function(e){e.preventDefault(),s.$searchBtn.trigger("click")})),e("#nm-shop-search-input").on("input",(function(){var a=s.searchValidateInput(e(this).val());"valid"===a?s.searchShowNotice():"invalid"===a&&s.searchHideNotice()})).trigger("input"),s.filtersEnableAjax&&s.$searchInput.on("keypress",(function(a){var n=e(this),r=n.val();"13"==(a.keyCode?a.keyCode:a.which)&&(a.preventDefault(),"valid"===s.searchValidateInput(r,!0)&&s.currentSearch!==r?n.hasClass("nm-mobile-menu-search")?(s.pageOverlayHide(),setTimeout((function(){e("#nm-mobile-menu-shop-search-input").val(""),s.shopSearchAjaxSearch(r)}),s.panelsAnimSpeed)):("0"!=nm_wp_vars.shopSearchAutoClose?s.$searchBtn.trigger("click"):s.searchHideNotice(),setTimeout((function(){s.shopSearchAjaxSearch(r)}),s.filterPanelSlideSpeed)):s.currentSearch=r)}))},shopSearchTogglePanel:function(){var s=this,a=e("#nm-shop-search-input");s.$searchPanel.slideToggle(200,(function(){s.$searchPanel.toggleClass("fade-in"),s.$searchPanel.hasClass("fade-in")?a.trigger("focus"):a.val(""),s.filterPanelSliding=!1})),s.searchHideNotice()},shopSearchAjaxSearch:function(s){var a=this;a.$searchInput.blur(),"popup"==a.shopSidebarLayout&&"0"!==nm_wp_vars.shopFiltersPopupAutoClose&&a.shopFiltersPopupHide(),a.shopShowLoader(),a.currentSearch=s;var n=nm_wp_vars.searchUrl.toString().replace("%%nmsearchkey%%",encodeURIComponent(s));a.searchAjax=e.ajax({url:n,data:{shop_load:"search",post_type:"product",shop_filters_layout:a.shopSidebarLayout},dataType:"html",method:"GET",error:function(e,s,n){console.log("NM: AJAX error - shopSearchAjaxSearch() - "+n),a.shopHideLoader(),a.searchAjax=null},success:function(e){a.shopUpdateContent(e),a.searchAjax=null}})},suggestionsGet:function(s){var a=this;if(a.instantSuggestions)return a.$searchPanel.addClass("doing-search"),a.instantSuggestionsGet(s),clearTimeout(a.instantSuggestionsPreloaderTo),void(a.instantSuggestionsPreloaderTo=setTimeout((function(){a.$searchPanel.removeClass("doing-search")}),800));a.suggestionsAjax&&a.suggestionsAjax.abort();var n=e("#nm-header-search-form"),r=e("#nm-search-suggestions"),t=a.suggestionsEscapeQuery(s);if(a.suggestionsCacheEnabled&&a.suggestionsCache[t])a.suggestionsShow(a.suggestionsCache[t],null,r);else{n.addClass("nm-loader"),r.children(".nm-search-suggestions-inner").children().length&&r.addClass("doing-search");var o="undefined"!=typeof wc_add_to_cart_params?wc_add_to_cart_params.wc_ajax_url:nm_wp_vars.woocommerceAjaxUrl;o=o.toString().replace("%%endpoint%%","nm_shop_search"),a.suggestionsAjax=e.ajax({type:"POST",url:o,data:{s:s},dataType:"html",success:function(e){a.suggestionsCacheEnabled&&a.suggestionsCacheResults(s,e),a.suggestionsShow(e,null,r)},complete:function(){n.removeClass("nm-loader"),a.suggestionsAjax=null}})}},suggestionsEscapeQuery:function(e){return encodeURIComponent(e)},suggestionsCacheResults:function(e,s){var a=this.suggestionsEscapeQuery(e);this.suggestionsCache[a]=s},suggestionsShow:function(s,a,n){var r=e("#nm-search-suggestions-product-list");if(r.html(s),n.removeClass("doing-search"),n.addClass("show"),0==(a=a||r.children().length))var t="no-results";else t=a==this.suggestionsMaxResults?"press-enter":"has-results";e("#nm-search-suggestions-notice").removeClass().addClass("show "+t),this.$searchPanel.addClass("has-suggestions")},suggestionsHide:function(){var s=this;s.suggestionsAjax&&s.suggestionsAjax.abort(),e("#nm-search-suggestions-product-list").html(""),e("#nm-search-suggestions").removeClass(),e("#nm-search-suggestions-notice").removeClass(),s.$searchPanel.removeClass("has-suggestions"),s.searchCurrentQuery=""},instantSuggestionsLoad:function(){var s=this;s.productDataJSON=null;var a="undefined"!=typeof wc_add_to_cart_params?wc_add_to_cart_params.wc_ajax_url:nm_wp_vars.woocommerceAjaxUrl;a=a.toString().replace("%%endpoint%%","nm_suggestions_product_data"),e.ajax({type:"post",url:a,dataType:"json",error:function(e,s,a){console.log("NM: AJAX error - instantSuggestionsLoad() - "+a)},success:function(e){s.productDataJSON=e}})},instantSuggestionsSearchData:function(e){e.normalize&&(e=e.normalize("NFD").replace(/[\u0300-\u036f]/g,""));var s,a,n=this,r=new RegExp(e,"i"),t=new RegExp("^"+e+"$"),o=0,i=[],c=e.split(" ");for(var h in c=c.slice(0,3),n.productDataJSON)if(n.productDataJSON.hasOwnProperty(h)){s=n.productDataJSON[h],a=0;for(var u=0;u<c.length;u++)s.title.match(new RegExp(c[u],"i"))&&a++;if((a>0&&a==c.length||s.categories&&-1!=s.categories.search(new RegExp(r))||s.tags&&-1!=s.tags.search(new RegExp(r))||s.sku&&t.test(s.sku))&&(o++,i.push(s)),o==n.suggestionsMaxResults)break}return i},instantSuggestionsGet:function(s){var a=this,n=a.instantSuggestionsSearchData(s),r="";if(n.length>0){for(var t=0;t<n.length;t++)r+=n[t].product_html;a.suggestionsShow(r,n.length,e("#nm-search-suggestions"))}else a.suggestionsShow("",0,e("#nm-search-suggestions"))}}),e.nmThemeExtensions.search=e.nmTheme.search_init}(jQuery);